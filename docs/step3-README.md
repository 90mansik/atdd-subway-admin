3단계-구간 추가 기능
===
# 미션 설명
### 기능 요구사항
- `요구사항 설명`에서 제공되는 요구사항을 기반으로 지하철 구간 추가 기능을 구현하세요.
- 요구사항을 정의한 인수 조건을 추출하세요.
- 인수 조건을 검증하는 인수 테스트를 작성하세요.
- 예외 케이스에 대한 검증도 포함하세요.

### 프로그래밍 요구사항
- 인수 테스트 주도 개발 프로세스에 맞춰서 기능을 구현하세요.
  - `요구사항 설명`을 참고하여 인수 조건을 정의
  - 인수 조건을 검증하는 인수 테스트 작성
  - 인수 테스트를 충족하는 기능 구현
- 인수 조건은 인수 테스트 메서드 상단에 주석으로 작성하세요.
  - 뼈대 코드의 인수 테스트를 참고
- 인수 테스트의 결과가 다른 인수 테스트에 영향을 끼치지 않도록 인수 테스트를 서로 격리 시키세요.
- 인수 테스트의 재사용성과 가독성, 그리고 빠른 테스트 의도 파악을 위해 인수 테스트를 리팩터링 하세요.

### 요구사항 설명 : 인수 조건
구간 등록 API Request
```
POST /lines/1/sections HTTP/1.1
accept: */*
content-type: application/json; charset=UTF-8
host: localhost:52165

{
    "downStationId": "4",
    "upStationId": "2",
    "distance": 10
}
```

지하철 구간 등록 인수 테스트 작성과 기능 구현
[x] 역 사이에 새로운 역을 등록할 경우
  - 새로운 길이를 뺀 나머지를 새롭게 추가된 역과의 길이로 설정
[x] 새로운 역을 상행 종점으로 등록할 경우
[x] 새로운 역을 하행 종점으로 등록할 경우

구간 등록시 예외 케이스를 고려하기
  - [x] 역 사이에 새로운 역을 등록할 경우 기존 역 사이 길이보다 크거나 같으면 등록을 할 수 없음
  - [x] 상행역과 하행역이 이미 노선에 모두 등록되어 있다면 추가할 수 없음
  - [x] 상행역과 하행역 둘 중 하나도 포함되어있지 않으면 추가할 수 없음

### 힌트
- @BeforeEach 구문에서 테스트 조건을 생성하여 각 테스트의 Given 절에 대한 중복 코드 제거
---

### 구현 기능 목록
- [x] 구간에 대한 Entity 설계
  - 노선과 구간에 대한 일대다 연관관계 설정
- [x] `@Embedded/@Embeddable`을 활용한 구간 일급 컬렉션 필드 적용
- [x] 구간 일급 컬렉션에 비지니스 로직 구현
  - [x] 신규 상행종점역 구간 추가
    - 상행역이 서로 다르고, 현재 상행역이 요청 하행역과 같은 경우
  - [x] 신규 하행종점역 구간 추가
    - 하행역이 서로 다르고, 현재 하행역이 요청 상행역과 같은 경우
  - [x] 중간에 구간 추가
    - 상행역이 동일하고, 하행역이 서로 다른 경우
    - 상행역이 서로 다르고, 하행역이 동일한 경우
- [x] 구간 추가 기능 구현에 필요한 기능 
  - [x] 상행종점역 찾기 : 각 구간의 상행역이, 어느 구간의 하행역에도 포함되지 않는 경우 (전체 상행역 집합과 전체 하행역 집합의 차집합)
  - [x] 하행종점역 찾기 : 각 구간의 하행역이, 어느 구간의 상행역에도 포함되지 않는 경우 (전체 하행역 집합과 전체 상행역 집합의 차집합)
  - [x] 상행종점역 혹은 하행종점역 둘중 하나를 기준으로 순회하며 다음 구간을 탐색, 구간 목록을 메모리상에서 정렬 
- [x] 예외 케이스에 대한 인수테스트 작성
  - [x] 동일 구간 추가 요청에 대한 예외
  - [x] 포함되는 구간이 없는 경우 예외
    - e.g. 신사-양재, 신논현-양재
  - [x] 추가하는 구간의 길이가 연결 구간의 길이보다 크거나 같은 경우 예외
- [x] 구간 등록 요청 객체 설계
- [x] 구간 추가 API에 대한 성공/실패 인수테스트 작성

### 구간 추가 경우의 수
[#1] case : 상행역이 동일하고 하행역이 달라 중간에 구간을 추가 하는 경우
```text
Given :
논현 - 정자

When :
논현 - 신논현

로직 구현 :
- `논현 - 정자` 구간을 `신논현 - 정자` 구간으로 변경 
- `논현 - 신논현` 구간을 추가

Then: 
논현 - 신논현
       신논현 - 정자

정렬된 역 목록 :
논현 - 신논현 - 정자
```

[#2] case : 하행역이 동일하고 상행역이 달라 중간에 구간을 추가 하는 경우
```text
Given :
논현 - 정자

When :
신논현 - 정자

로직 구현 :
- `논현 - 정자` 구간을 `논현 - 신논현` 구간으로 변경
- `신논현 - 정자` 구간을 추가

Then :
논현 - 신논현
       신논현 - 정자

정렬된 역 목록 :
논현 - 신논현 - 정자
```

[#3] case : 신규 상행 종점역 추가
```text
Given :
논현 - 정자

When :
신사 - 논현

로직 구현 :
-`신사 - 논현` 구간을 추가

Then :
신사 - 논현
       논현 - 정자

정렬된 역 목록 :
신사 - 논현 - 정자
```

[#4] case : 신규 하행 종점역 추가
```text
Given :
논현 - 정자

When :
정자 - 광교

로직 구현 :
-`정자 - 광교` 구간을 추가

Then :
논현 - 정자
       정자 - 광교

정렬된 역 목록 :
논현 - 정자 - 광교
```

### 리팩토링 목록
- [x] TC에 중복으로 사용될 수 있는 인수조건의 각 단계를 한글로 표현하여 가독성 개선

---

### 3주차 인수 테스트 주도 개발 영상 내용 정리
- 각 인수 테스트 수행 환경을 격리
  - EntityManager를 이용한 turncate를 이용하여 tearDonw 진행
- 테스트 중복 제거
  - 각 TC에 반복적으로 수행되는 생성부 추출 하기
- 테스트 의도 표현
   - 테스트의 각 스텝을 한글 메서드로 표현하여 의도를 명확히 드러내기
- 인수 조건을 테스트로 옮기기
Feature 기준으로 인수테스트 클래스를 분리
Scenario 기준으로 인수테스트 메서드를 분리
Feature 내부에 있는 Scenario는 같은 텍스트 픽스쳐를 공유
```
given: 지하철 역 등록 request 보내기
when: 지하철역 삭제 reqeust 보내기
then: 지하철역 삭제를 확인하기
- 지하철 역 삭제 요청의 응답 코드로 확인
- 지하철 역 조회 request 후 response 값에서 확인
```
- 테스트 코드 작성 팁
  - 간단한 성공 케이스 우선 작성
  - 기능 제공에서 발생 가능한 실패 케이스 작성
  - When > Then > Given 순으로 작성
  
### 코드 리뷰 피드백 내용
- [ ] 잘못 작성된 구간 추가 API 경로 수정
- [ ] 구간 추가 인수테스트에 누락된 BaseTest 상속 추가
- [ ] 테스트 코드 수정
  - [ ] Test 표현 개선
    - `@DisplayName`에만 테스트를 표현하고 메소드에는 표현하지 않은 테스트명 개선
    - 너무 많은 정보를 표현하다보니 오히려 가독성이 떨어진 테스트 표현 개선
  - [ ] TC 작성을 위해 반복적으로 사용되는 객체 생성 부를 별도의 Fixture로 분리
- [ ] 계층간 데이터 전송을 담당하는 DTO에 구현된 로직을 service 계층으로 이관  
- [ ] 코드내 직접 명시된 매직넘버의 상수 처리
- [ ] 기타 불필요 코드 및 미사용 코드 제거
